<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calling App</title>
  <link rel="stylesheet" href="/css/materialize.min.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    .right_float{
      right: 0;
    }
    .icon-button {
      display: inline-flex; /* Align with text */
      align-items: center; /* Center vertically */
      background-color: transparent; /* No background */
      border: none; /* Remove default border */
      cursor: pointer; /* Pointer cursor */
      color: inherit; /* Inherit text color */
      text-decoration: none; /* Remove underline */
    }

    .icon-button:hover {
      color: #26a69a; /* Change color on hover */
    }

    .fixed-bottom {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      z-index: 1000; /* Ensures it is above other content */
    }
    .custom-send{
      padding: 10px;
      color: white;
      border-radius: 8px 8px 0px 8px;
      margin: 10px 10px 10px 90px;
    }

    .custom-send2{
      padding: 10px;
      color: white;
      border-radius: 8px 8px 8px 0px;
      margin: 10px 90px 10px 10px;
    }
    .localvideostream{
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: -2;
    }
    .home{
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: -1;
      background: white;
    }
    .customer_three_dot_button_changes{
      top: 23px;
    }
    #dropdown1 {
      visibility: visible !important;
      bottom: auto;
    }

  </style>
</head>
<body>
  <!-- <h3 >Calling App</h3> -->
  <input id="sessionId" type="text" placeholder="Enter Session ID">
  <button id="joinButton" class="btn blue">Join Call</button>
  <button id="callButton" class="btn blue" >Start Call</button>
  <div class="fixed-action-btn customer_three_dot_button_changes">
    <a class="btn-floating btn-large blue dropdown-trigger" data-target="dropdown1" >
      <i class="material-icons">more_vert</i>
    </a>
    <ul id="dropdown1"  class="dropdown-content">
      <li><a href="#!">Add Friends</a></li>
      <li><a href="#!">Option 2</a></li>
      <li><a href="#!">Option 3</a></li>
    </ul>
  </div>


  <video id="localVideo" class="localvideostream" autoplay muted></video>
  
  <div class="home">

  </div>
  <video id="remoteVideo" autoplay></video>

  <!-- <input id="messageInput" type="text" placeholder="Type a message..." /> -->
  <div class="row">
    <form class="col s12">
      <div class="row">
        <div class="input-field col s12 fixed-bottom" style="background: white;margin: 0rem 0rem;">
          <i class="material-icons prefix right_float icon-button" onclick="sendMessage()">send</i>
          <textarea id="messageInput" class="materialize-textarea" style="margin: 0;" spellcheck="false"></textarea>
          <label for="messageInput" style="margin: 0;">Message</label>
        </div>
      </div>
    </form>
  </div>
  <!-- <button onclick="sendMessage()">Send</button> -->
  <ul id="messages"></ul>
  <!-- <button id="callButton">Start Call</button> -->
  <script src="/js/materialize.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
        var elems = document.querySelectorAll('.dropdown-trigger');
        M.Dropdown.init(elems, {
          // Customize dropdown options if needed
        });
      });
  </script>
    
  <script>
    
    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');

    let ws;

    let localStream;
    let remoteStream;
    let peerConnection;
    const configuration = {
      iceServers: [
        {
          urls: 'stun:stun.l.google.com:19302'
        }
      ]
    };

    navigator.mediaDevices.getUserMedia({ video: true, audio: true })
      .then(stream => {
        localVideo.srcObject = stream;
        localStream = stream;

        // ws.addEventListener('open', () => {
        //   console.log('WebSocket connection opened');
        // });
      })
      .catch(error => console.error('Error accessing media devices.', error));


    document.getElementById('joinButton').addEventListener('click', () => {
      const sessionId = document.getElementById('sessionId').value;
      console.log(window.location.hostname);
      // let websocketUrl = 
      if ( window.location.protocol == "https:" ){
        ws = new WebSocket(`wss://${window.location.hostname}:${window.location.port}?sessionId=${sessionId}`);
      }else{
        ws = new WebSocket(`ws://${window.location.hostname}:${window.location.port}?sessionId=${sessionId}`);
      }
      
      console.log(ws);
      ws.addEventListener('open', () => {
        console.log('WebSocket connection opened');
      });

      ws.addEventListener('message', (message) => {

        console.log(message.data);

        message.data.text().then(text => {

          // try {
          //     const parsedData = JSON.parse(jsonString);
          //     console.log(parsedData); // Handle your parsed data here
          // } catch (error) {
          //     console.error('Error parsing JSON:', error);
          // }

          const messages1 = document.getElementById('messages');
          const message1 = document.createElement('li');
          message1.textContent = text;
          message1.classList.add('blue');
          message1.classList.add('custom-send2');          
          messages1.appendChild(message1);

          const parsedMessage = JSON.parse(text);
          handleSignalingData(parsedMessage);

        });

        // if (message.data instanceof Blob) {

        //   blobToJson(message.data)
        //       .then(json => {
        //           console.log('JSON:', json);
        //       })
        //       .catch(error => {
        //           console.error('Error converting Blob to JSON:', error);
        //       });


        // } else {
        //     console.log('Message from server:', message.data);
        //     message.textContent = reader.result;
        //     messages.appendChild(message);
        // }


      });

      ws.addEventListener('close', (event) => {
        console.log('WebSocket connection closed:', event);
        console.log('Code:', event.code, 'Reason:', event.reason);
      });


      ws.addEventListener('error', (error) => {
        console.error('WebSocket error', error);
      });



    });

    function sendMessage() {
        const input = document.getElementById('messageInput');
        ws.send(input.value);
        const messages = document.getElementById('messages');
        const message = document.createElement('li');
        message.textContent = input.value;
        message.classList.add('blue');
        message.classList.add('custom-send');
        messages.appendChild(message);
        input.value = '';
    }

        
    function blobToJson(blob) {
      return new Promise((resolve, reject) => {
          const reader = new FileReader();

          reader.onload = () => {
          try {
              const json = JSON.parse(reader.result);
              resolve(json);
          } catch (error) {
              reject(error);
          }
          };

          reader.onerror = () => {
          reject(reader.error);
          };

          reader.readAsText(blob);
      });
    }


    function handleSignalingData(data) {
      switch (data.type) {
        case 'offer':
          handleOffer(data.offer);
          break;
        case 'answer':
          handleAnswer(data.answer);
          break;
        case 'candidate':
          handleCandidate(data.candidate);
          break;
        default:
          break;
      }
    }

    function handleOffer(offer) {
      createPeerConnection();
      peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
      peerConnection.createAnswer()
        .then(answer => {
          peerConnection.setLocalDescription(answer);
          ws.send(JSON.stringify({ type: 'answer', answer }));
        })
        .catch(error => console.error('Error creating answer', error));
    }

    function handleAnswer(answer) {
      peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
    }

    function handleCandidate(candidate) {
      peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
    }



    document.getElementById('callButton').addEventListener('click', () => {
      createPeerConnection();

      peerConnection.createOffer()
        .then(offer => {
          peerConnection.setLocalDescription(offer);
          ws.send(JSON.stringify({ type: 'offer', offer }));
        })
        .catch(error => console.error('Error creating offer', error));
    });



    // ws.addEventListener('message', (message) => {
    //   // const parsedMessage = JSON.parse(message.data);
    //   // switch (parsedMessage.type) {
    //   //   case 'offer':
    //   //     createPeerConnection();
    //   //     peerConnection.setRemoteDescription(new RTCSessionDescription(parsedMessage.offer));
    //   //     peerConnection.createAnswer()
    //   //       .then(answer => {
    //   //         peerConnection.setLocalDescription(answer);
    //   //         ws.send(JSON.stringify({ type: 'answer', answer }));
    //   //       });
    //   //     break;
    //   //   case 'answer':
    //   //     peerConnection.setRemoteDescription(new RTCSessionDescription(parsedMessage.answer));
    //   //     break;
    //   //   case 'candidate':
    //   //     peerConnection.addIceCandidate(new RTCIceCandidate(parsedMessage.candidate));
    //   //     break;
    //   // }

    //   message.data.text().then(text => {
    //     const parsedMessage = JSON.parse(text);
    //     switch (parsedMessage.type) {
    //       case 'offer':
    //         createPeerConnection();
    //         peerConnection.setRemoteDescription(new RTCSessionDescription(parsedMessage.offer));
    //         peerConnection.createAnswer()
    //           .then(answer => {
    //             peerConnection.setLocalDescription(answer);
    //             ws.send(JSON.stringify({ type: 'answer', answer }));
    //           });
    //         break;
    //       case 'answer':
    //         peerConnection.setRemoteDescription(new RTCSessionDescription(parsedMessage.answer));
    //         break;
    //       case 'candidate':
    //         peerConnection.addIceCandidate(new RTCIceCandidate(parsedMessage.candidate));
    //         break;
    //     }
    //   });
    // });

    function createPeerConnection() {
      peerConnection = new RTCPeerConnection(configuration);

      peerConnection.addEventListener('icecandidate', event => {
        if (event.candidate) {
          ws.send(JSON.stringify({ type: 'candidate', candidate: event.candidate }));
        }
      });

      peerConnection.addEventListener('track', event => {
        remoteVideo.srcObject = event.streams[0];
      });

      localStream.getTracks().forEach(track => {
        peerConnection.addTrack(track, localStream);
      });
    }

    // document.getElementById('callButton').addEventListener('click', () => {
    //   createPeerConnection();

    //   peerConnection.createOffer()
    //     .then(offer => {
    //       peerConnection.setLocalDescription(offer);
    //       ws.send(JSON.stringify({ type: 'offer', offer }));
    //     });
    // });
    
  </script>


</body>
</html>
